<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `spirit_tokio` crate."><meta name="keywords" content="rust, rustlang, rust-lang, spirit_tokio"><title>spirit_tokio - Rust</title><link rel="stylesheet" type="text/css" href="../normalize.css"><link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../light.css"  id="themeStyle"><link rel="stylesheet" type="text/css" href="../dark.css" disabled ><link rel="stylesheet" type="text/css" href="../ayu.css" disabled ><script src="../storage.js"></script><noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="icon" type="image/svg+xml" href="../favicon.svg">
<link rel="alternate icon" type="image/png" href="../favicon-16x16.png">
<link rel="alternate icon" type="image/png" href="../favicon-32x32.png"><style type="text/css">#crate-search{background-image:url("../down-arrow.svg");}</style></head><body class="rustdoc mod"><!--[if lte IE 8]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu">&#9776;</div><a href='../spirit_tokio/index.html'><div class='logo-container rust-logo'><img src='../rust-logo.png' alt='logo'></div></a><p class="location">Crate spirit_tokio</p><div class="block version"><p>Version 0.6.1</p></div><div class="sidebar-elems"><a id="all-types" href="all.html"><p>See all spirit_tokio's items</p></a><div class="block items"><ul><li><a href="#reexports">Re-exports</a></li><li><a href="#modules">Modules</a></li></ul></div><p class="location"></p><script>window.sidebarCurrent = {name: "spirit_tokio", ty: "mod", relpath: "../"};</script></div></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg" width="18" alt="Pick another theme!"></button><div id="theme-choices"></div></div><script src="../theme.js"></script><nav class="sub"><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" disabled autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><span class="help-button">?</span>
                <a id="settings-menu" href="../settings.html"><img src="../wheel.svg" width="18" alt="Change settings"></a></div></form></nav><section id="main" class="content"><h1 class="fqn"><span class="out-of-band"><span id="render-detail"><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span><a class="srclink" href="../src/spirit_tokio/lib.rs.html#1-130" title="goto source code">[src]</a></span><span class="in-band">Crate <a class="mod" href="">spirit_tokio</a></span></h1><div class="docblock"><p>A collection of <a href="../spirit/fragment/trait.Fragment.html"><code>Fragment</code></a>s and <a href="../spirit/extension/trait.Extension.html"><code>Extension</code></a>s integrating tokio primitives into <a href="https://crates.io/crates/spirit.">spirit</a>.</p>
<p>The crate provides utilities to auto-configure tokio primitives, like listening sockets. This
allows, for example, specifying just the function that handles a single connection and let
spirit handle all the rest ‒ creating and shutting down the listening socket based on the
configuration changes, specifying details like the listen backlog or TCP keepalive, etc. It
couples them together and spawns the resulting future onto a tokio runtime (also created by
this crate, around the main body of application).</p>
<h1 id="available-fragments" class="section-header"><a href="#available-fragments">Available fragments</a></h1>
<ul>
<li><a href="../spirit_tokio/net/struct.TcpListen.html" title="TcpListen"><code>TcpListen</code></a> for <a href="../tokio_tcp/listener/struct.TcpListener.html"><code>TcpListener</code></a></li>
<li><a href="../spirit_tokio/net/struct.UdpListen.html" title="UdpListen"><code>UdpListen</code></a> for <a href="../tokio_udp/socket/struct.UdpSocket.html"><code>UdpSocket</code></a> (bound to an address)</li>
<li><a href="../spirit_tokio/net/unix/struct.UnixListen.html"><code>UnixListen</code></a> for <a href="../tokio_uds/listener/struct.UnixListener.html"><code>UnixListener</code></a> (available on unix systems)</li>
<li><a href="../spirit_tokio/net/unix/struct.DatagramListen.html"><code>DatagramListen</code></a> for <a href="../tokio_uds/datagram/struct.UnixDatagram.html"><code>UnixDatagram</code></a> (available on unix systems)</li>
</ul>
<p>The <a href="../spirit_tokio/net/limits/struct.WithListenLimits.html"><code>WithListenLimits</code></a> is a wrapper that adds limits to number of concurrent connections as
well as a backoff timeout in case of soft errors (like „Too many open files“). There are also
type aliases <a href="../spirit_tokio/net/type.TcpListenWithLimits.html" title="TcpListenWithLimits"><code>TcpListenWithLimits</code></a> and <a href="../spirit_tokio/net/unix/type.UnixListenWithLimits.html"><code>UnixListenWithLimits</code></a>.</p>
<h1 id="runtime" class="section-header"><a href="#runtime">Runtime</a></h1>
<p>Currently, the crate supports spawning futures on the default runtime only. It also sets up the
default runtime as part of the pipelines. However, this works only if at least one pipeline is
plugged into the <a href="../spirit/spirit/struct.Builder.html"><code>Builder</code></a>. If all the pipelines you install into <a href="https://crates.io/crates/spirit.">spirit</a> are plugged after
building, it'll panic.</p>
<p>In such case, the runtime needs to be plugged in manually as part of the setup, like this:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">Spirit</span>::<span class="op">&lt;</span><span class="ident">Empty</span>, <span class="ident">Empty</span><span class="op">&gt;</span>::<span class="ident">new</span>()
    .<span class="ident">with_singleton</span>(<span class="ident">Runtime</span>::<span class="ident">default</span>())
    .<span class="ident">run</span>(<span class="op">|</span><span class="ident">_spirit</span><span class="op">|</span> {
        <span class="comment">// Plugging spirit-tokio pipelines in here into _spirit</span>
        <span class="prelude-val">Ok</span>(())
    });</pre></div>
<h1 id="examples" class="section-header"><a href="#examples">Examples</a></h1>
<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="kw">use</span> <span class="ident">std</span>::<span class="ident">sync</span>::<span class="ident">Arc</span>;

<span class="kw">use</span> <span class="ident">serde</span>::<span class="ident">Deserialize</span>;
<span class="kw">use</span> <span class="ident">spirit</span>::{<span class="ident">AnyError</span>, <span class="ident">Empty</span>, <span class="ident">Pipeline</span>, <span class="ident">Spirit</span>};
<span class="kw">use</span> <span class="ident">spirit</span>::<span class="ident">prelude</span>::<span class="kw-2">*</span>;
<span class="kw">use</span> <span class="ident">spirit_tokio</span>::{<span class="ident">HandleListener</span>, <span class="ident">TcpListenWithLimits</span>};
<span class="kw">use</span> <span class="ident">tokio</span>::<span class="ident">prelude</span>::<span class="kw-2">*</span>;

<span class="kw">const</span> <span class="ident">DEFAULT_CONFIG</span>: <span class="kw-2">&amp;</span><span class="ident">str</span> <span class="op">=</span> <span class="string">r#&quot;
[listening_socket]
port = 1234
max-conn = 20
error-sleep = &quot;100ms&quot;
&quot;#</span>;

<span class="attribute">#[<span class="ident">derive</span>(<span class="ident">Default</span>, <span class="ident">Deserialize</span>)]</span>
<span class="kw">struct</span> <span class="ident">Config</span> {
    <span class="ident">listening_socket</span>: <span class="ident">TcpListenWithLimits</span>,
}

<span class="kw">impl</span> <span class="ident">Config</span> {
    <span class="kw">fn</span> <span class="ident">listening_socket</span>(<span class="kw-2">&amp;</span><span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">TcpListenWithLimits</span> {
        <span class="self">self</span>.<span class="ident">listening_socket</span>.<span class="ident">clone</span>()
    }
}

<span class="kw">fn</span> <span class="ident">connection</span><span class="op">&lt;</span><span class="ident">C</span>: <span class="ident">AsyncRead</span> <span class="op">+</span> <span class="ident">AsyncWrite</span><span class="op">&gt;</span>(<span class="ident">conn</span>: <span class="ident">C</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="kw">impl</span> <span class="ident">Future</span><span class="op">&lt;</span><span class="ident">Item</span> <span class="op">=</span> (), <span class="ident">Error</span> <span class="op">=</span> <span class="ident">AnyError</span><span class="op">&gt;</span> {
    <span class="ident">tokio</span>::<span class="ident">io</span>::<span class="ident">write_all</span>(<span class="ident">conn</span>, <span class="string">&quot;Hello\n&quot;</span>)
        .<span class="ident">map</span>(<span class="op">|</span><span class="kw">_</span><span class="op">|</span> ())
        .<span class="ident">map_err</span>(<span class="ident">AnyError</span>::<span class="ident">from</span>)
}

<span class="kw">fn</span> <span class="ident">main</span>() {
    <span class="ident">Spirit</span>::<span class="op">&lt;</span><span class="ident">Empty</span>, <span class="ident">Config</span><span class="op">&gt;</span>::<span class="ident">new</span>()
        .<span class="ident">config_defaults</span>(<span class="ident">DEFAULT_CONFIG</span>)
        .<span class="ident">with</span>(
            <span class="ident">Pipeline</span>::<span class="ident">new</span>(<span class="string">&quot;listener&quot;</span>)
                .<span class="ident">extract_cfg</span>(<span class="ident">Config</span>::<span class="ident">listening_socket</span>)
                .<span class="ident">transform</span>(<span class="ident">HandleListener</span>(<span class="op">|</span><span class="ident">conn</span>, <span class="ident">_cfg</span>: <span class="kw-2">&amp;</span><span class="kw">_</span><span class="op">|</span> <span class="ident">connection</span>(<span class="ident">conn</span>)))
        )
        .<span class="ident">run</span>(<span class="op">|</span><span class="ident">spirit</span><span class="op">|</span> {
            <span class="prelude-val">Ok</span>(())
        });
}</pre></div>
<p>Further examples are in the
<a href="https://github.com/vorner/spirit/tree/master/spirit-tokio/examples">git repository</a>.</p>
</div><h2 id="reexports" class="section-header"><a href="#reexports">Re-exports</a></h2>
<table><tr><td><code>pub use crate::handlers::<a class="struct" href="../spirit_tokio/handlers/struct.HandleListener.html" title="struct spirit_tokio::handlers::HandleListener">HandleListener</a>;</code></td></tr><tr><td><code>pub use crate::handlers::<a class="struct" href="../spirit_tokio/handlers/struct.HandleListenerInit.html" title="struct spirit_tokio::handlers::HandleListenerInit">HandleListenerInit</a>;</code></td></tr><tr><td><code>pub use crate::handlers::<a class="struct" href="../spirit_tokio/handlers/struct.HandleSocket.html" title="struct spirit_tokio::handlers::HandleSocket">HandleSocket</a>;</code></td></tr><tr><td><code>pub use crate::net::<a class="struct" href="../spirit_tokio/net/struct.TcpListen.html" title="struct spirit_tokio::net::TcpListen">TcpListen</a>;</code></td></tr><tr><td><code>pub use crate::net::<a class="type" href="../spirit_tokio/net/type.TcpListenWithLimits.html" title="type spirit_tokio::net::TcpListenWithLimits">TcpListenWithLimits</a>;</code></td></tr><tr><td><code>pub use crate::net::<a class="struct" href="../spirit_tokio/net/struct.UdpListen.html" title="struct spirit_tokio::net::UdpListen">UdpListen</a>;</code></td></tr><tr><td><code>pub use crate::runtime::<a class="enum" href="../spirit_tokio/runtime/enum.Runtime.html" title="enum spirit_tokio::runtime::Runtime">Runtime</a>;</code></td></tr></table><h2 id="modules" class="section-header"><a href="#modules">Modules</a></h2>
<table><tr class="module-item"><td><a class="mod" href="either/index.html" title="spirit_tokio::either mod">either</a></td><td class="docblock-short"><p>Support for alternative choices of configuration.</p>
</td></tr><tr class="module-item"><td><a class="mod" href="handlers/index.html" title="spirit_tokio::handlers mod">handlers</a></td><td class="docblock-short"><p>Handlers of connections and sockets.</p>
</td></tr><tr class="module-item"><td><a class="mod" href="installer/index.html" title="spirit_tokio::installer mod">installer</a></td><td class="docblock-short"><p>Installer of futures.</p>
</td></tr><tr class="module-item"><td><a class="mod" href="net/index.html" title="spirit_tokio::net mod">net</a></td><td class="docblock-short"><p>Autoconfiguration of network primitives of <a href="../tokio/index.html" title="tokio">tokio</a></p>
</td></tr><tr class="module-item"><td><a class="mod" href="runtime/index.html" title="spirit_tokio::runtime mod">runtime</a></td><td class="docblock-short"><p>An extension to start the tokio runtime at the appropriate time.</p>
</td></tr></table></section><section id="search" class="content hidden"></section><section class="footer"></section><script>window.rootPath = "../";window.currentCrate = "spirit_tokio";</script><script src="../main.js"></script><script defer src="../search-index.js"></script></body></html>